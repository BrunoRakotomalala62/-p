
const axios = require('axios');
const sendMessage = require('../handles/sendMessage');

// Stockage de l'historique de conversation pour chaque utilisateur
const conversationHistory = {};

module.exports = async (senderId, args) => {
    try {
        console.log('Commande poesie appel√©e avec args:', args);
        // G√©rer le cas o√π args est une cha√Æne de caract√®res ou un tableau
        const userInput = typeof args === 'string' ? args.trim() : (Array.isArray(args) ? args.join(' ').trim() : '');
        console.log('Input utilisateur:', userInput);

        if (!userInput) {
            return sendMessage(senderId, "‚ùå Veuillez fournir un mot-cl√© pour rechercher des po√®mes.\nExemple: poesie fitiavana");
        }

        // V√©rifier si l'utilisateur a envoy√© un num√©ro (s√©lection d'un po√®me)
        const numeroMatch = userInput.match(/^\d+$/);
        
        if (numeroMatch && conversationHistory[senderId]) {
            // L'utilisateur a s√©lectionn√© un num√©ro
            const numero = parseInt(userInput);
            const lastSearch = conversationHistory[senderId];

            if (numero < 1 || numero > 20) {
                return sendMessage(senderId, "‚ùå Veuillez choisir un num√©ro entre 1 et 20.");
            }

            // Appel √† la deuxi√®me API pour obtenir les d√©tails du po√®me
            const detailUrl = `https://tonontako-audio.vercel.app/tonony?numero=${numero}&tononkalo=${encodeURIComponent(lastSearch.keyword)}&page=${lastSearch.page}`;
            
            const detailResponse = await axios.get(detailUrl);
            const detailData = detailResponse.data;

            if (!detailData || !detailData.tonony) {
                return sendMessage(senderId, "‚ùå Impossible de r√©cup√©rer les d√©tails de ce po√®me.");
            }

            // Envoyer l'audio si disponible
            if (detailData.mp3) {
                await sendMessage(senderId, {
                    attachment: {
                        type: 'audio',
                        payload: {
                            url: detailData.mp3,
                            is_reusable: true
                        }
                    }
                });
            }

            // Envoyer les d√©tails du po√®me
            const message = `üìù Mpanoratra: ${detailData.auteur}\n\nüéµ mp3: ${detailData.mp3}\n\n${detailData.tonony}`;
            
            await sendMessage(senderId, message);

        } else {
            // L'utilisateur a envoy√© un mot-cl√© pour rechercher
            const keyword = userInput;
            const page = 1;

            // Appel √† la premi√®re API pour la recherche
            const searchUrl = `https://tonontako-audio.vercel.app/recherche?tononkalo=${encodeURIComponent(keyword)}&page=${page}`;
            console.log('URL de recherche:', searchUrl);
            
            const searchResponse = await axios.get(searchUrl);
            console.log('R√©ponse API re√ßue:', JSON.stringify(searchResponse.data));
            const searchData = searchResponse.data;

            if (!searchData || !searchData.Reponse) {
                console.log('Pas de r√©sultats dans la r√©ponse');
                return sendMessage(senderId, "‚ùå Aucun r√©sultat trouv√© pour votre recherche.");
            }

            // Sauvegarder l'historique de recherche pour cet utilisateur
            conversationHistory[senderId] = {
                keyword: keyword,
                page: page,
                timestamp: Date.now()
            };

            // Envoyer la liste des r√©sultats
            const message = `üîç R√©sultats pour "${keyword}":\n\n${searchData.Reponse}\n\nüí° R√©pondez avec un num√©ro (1-20) pour voir les d√©tails du po√®me.`;
            
            await sendMessage(senderId, message);
        }

    } catch (error) {
        console.error('Erreur dans la commande poesie:', error);
        console.error('D√©tails de l\'erreur:', error.response ? error.response.data : error.message);
        
        if (error.response) {
            console.error('Code status:', error.response.status);
            console.error('Donn√©es de r√©ponse:', error.response.data);
        }
        
        await sendMessage(senderId, `‚ùå Une erreur s'est produite lors de la recherche de po√®mes. Veuillez r√©essayer.\nD√©tails: ${error.message}`);
    }
};

// Nettoyer l'historique ancien (plus de 30 minutes)
setInterval(() => {
    const now = Date.now();
    const thirtyMinutes = 30 * 60 * 1000;
    
    for (const userId in conversationHistory) {
        if (now - conversationHistory[userId].timestamp > thirtyMinutes) {
            delete conversationHistory[userId];
        }
    }
}, 5 * 60 * 1000); // V√©rifier toutes les 5 minutes

module.exports.info = {
    name: "poesie",
    description: "Recherche et affiche des po√®mes malagasy avec audio.",
    usage: "Envoyez 'poesie <mot-cl√©>' pour rechercher, puis r√©pondez avec un num√©ro (1-20) pour voir les d√©tails."
};
