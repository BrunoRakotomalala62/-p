
const axios = require('axios');
const sendMessage = require('../handles/sendMessage');

// Stockage des images en attente par utilisateur
const pendingImages = {};

// Gestion des sessions utilisateur
const userSessions = {};

// Fonction pour envoyer des messages longs en plusieurs parties intelligemment
async function sendLongMessage(senderId, message) {
    const MAX_MESSAGE_LENGTH = 1900;

    if (message.length <= MAX_MESSAGE_LENGTH) {
        await sendMessage(senderId, message);
        return;
    }

    let startIndex = 0;
    
    while (startIndex < message.length) {
        let endIndex = startIndex + MAX_MESSAGE_LENGTH;
        
        if (endIndex < message.length) {
            const separators = ['. ', ', ', ' ', '! ', '? ', '.\n', ',\n', '!\n', '?\n', '\n\n', '\n', ':', ';'];
            let bestBreakPoint = -1;
            
            for (const separator of separators) {
                const lastSeparator = message.lastIndexOf(separator, endIndex);
                if (lastSeparator > startIndex && (bestBreakPoint === -1 || lastSeparator > bestBreakPoint)) {
                    bestBreakPoint = lastSeparator + separator.length;
                }
            }
            
            if (bestBreakPoint !== -1) {
                endIndex = bestBreakPoint;
            }
        } else {
            endIndex = message.length;
        }
        
        const messagePart = message.substring(startIndex, endIndex);
        await sendMessage(senderId, messagePart);
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        startIndex = endIndex;
    }
}

module.exports = async (senderId, prompt, api, imageAttachments) => {
    try {
        // Initialiser la session utilisateur si n√©cessaire
        if (!userSessions[senderId]) {
            userSessions[senderId] = { uid: senderId };
        }

        // V√©rifier si nous avons des images en pi√®ce jointe
        if (imageAttachments && imageAttachments.length > 0) {
            const imageUrl = imageAttachments[0].payload.url;
            
            // Stocker l'image et attendre la question
            pendingImages[senderId] = imageUrl;
            
            // Si l'utilisateur a envoy√© une question avec l'image, traiter directement
            if (prompt && prompt.trim().length > 0 && prompt !== "IMAGE_ATTACHMENT") {
                // Continuer le traitement avec la question
            } else {
                // Si pas de question, demander √† l'utilisateur
                await sendMessage(senderId, "üá≤üá¨ J'ai bien re√ßu votre photo, quel questions avez vous pos√© sur cette image? ‚ù§Ô∏è");
                return { skipCommandCheck: true };
            }
        }

        // Si l'utilisateur envoie "clear", r√©initialiser la conversation
        if (prompt.toLowerCase() === 'clear') {
            delete userSessions[senderId];
            delete pendingImages[senderId];
            await sendMessage(senderId, "Conversation r√©initialis√©e.");
            return;
        }

        // Envoyer un message de confirmation
        await sendMessage(senderId, "üìú‚ú® Pr√©paration de la r√©ponse... ‚ú®üìú");

        let response;
        let apiResponse;

        // Si l'utilisateur a une image en attente, utiliser l'API avec image
        if (pendingImages[senderId]) {
            const imageUrl = pendingImages[senderId];
            
            // V√©rifier que le prompt n'est pas vide
            if (!prompt || prompt.trim() === '' || prompt === 'IMAGE_ATTACHMENT') {
                await sendMessage(senderId, "üá≤üá¨ J'ai bien re√ßu votre photo, quel questions avez vous pos√© sur cette image? ‚ù§Ô∏è");
                return { skipCommandCheck: true };
            }
            
            // URL de l'API avec image
            const apiUrl = `https://claody7.vercel.app/claude?question=${encodeURIComponent(prompt)}&image=${encodeURIComponent(imageUrl)}&uid=${userSessions[senderId].uid}`;
            
            console.log('=== API TOJO IMAGE ===');
            console.log('Image URL:', imageUrl);
            console.log('Question:', prompt);
            console.log('API URL:', apiUrl);
            
            try {
                apiResponse = await axios.get(apiUrl, { 
                    timeout: 30000,
                    validateStatus: function (status) {
                        return status < 500;
                    }
                });
                
                console.log('R√©ponse API avec image:', JSON.stringify(apiResponse.data, null, 2));
                
                // V√©rifier diff√©rents formats de r√©ponse possibles
                if (apiResponse.data) {
                    if (apiResponse.data.response && typeof apiResponse.data.response === 'string' && apiResponse.data.response.trim() !== '') {
                        response = apiResponse.data.response;
                    } else if (apiResponse.data.result && typeof apiResponse.data.result === 'string' && apiResponse.data.result.trim() !== '') {
                        response = apiResponse.data.result;
                    } else if (apiResponse.data.message && typeof apiResponse.data.message === 'string' && apiResponse.data.message.trim() !== '') {
                        response = apiResponse.data.message;
                    } else if (typeof apiResponse.data === 'string' && apiResponse.data.trim() !== '') {
                        response = apiResponse.data;
                    } else {
                        console.error('Structure de r√©ponse inattendue:', apiResponse.data);
                        console.error('Cl√©s disponibles:', Object.keys(apiResponse.data));
                        response = 'Aucune r√©ponse re√ßue de l\'API. Veuillez r√©essayer.';
                    }
                } else {
                    console.error('Pas de donn√©es dans la r√©ponse');
                    response = 'Aucune r√©ponse re√ßue de l\'API. Veuillez r√©essayer.';
                }
            } catch (imageApiError) {
                console.error('Erreur lors de l\'appel API avec image:', imageApiError.message);
                response = 'Erreur lors de l\'analyse de l\'image. Veuillez r√©essayer.';
            }
            
            // Supprimer l'image apr√®s avoir r√©pondu
            delete pendingImages[senderId];
        } else {
            // Utiliser l'API textuelle
            const apiUrl = `https://claody7.vercel.app/Claude?question=${encodeURIComponent(prompt)}&uid=${userSessions[senderId].uid}`;
            
            console.log('=== API TOJO TEXTE ===');
            console.log('API URL:', apiUrl);
            
            apiResponse = await axios.get(apiUrl, { timeout: 30000 });
            console.log('R√©ponse API textuelle:', JSON.stringify(apiResponse.data, null, 2));
            
            // V√©rifier diff√©rents formats de r√©ponse possibles
            if (apiResponse.data) {
                if (apiResponse.data.response && typeof apiResponse.data.response === 'string' && apiResponse.data.response.trim() !== '') {
                    response = apiResponse.data.response;
                } else if (apiResponse.data.result && typeof apiResponse.data.result === 'string' && apiResponse.data.result.trim() !== '') {
                    response = apiResponse.data.result;
                } else if (apiResponse.data.message && typeof apiResponse.data.message === 'string' && apiResponse.data.message.trim() !== '') {
                    response = apiResponse.data.message;
                } else if (typeof apiResponse.data === 'string' && apiResponse.data.trim() !== '') {
                    response = apiResponse.data;
                } else {
                    console.error('Structure de r√©ponse inattendue:', apiResponse.data);
                    console.error('Cl√©s disponibles:', Object.keys(apiResponse.data));
                    response = 'Aucune r√©ponse re√ßue de l\'API';
                }
            } else {
                console.error('Pas de donn√©es dans la r√©ponse');
                response = 'Aucune r√©ponse re√ßue de l\'API';
            }
        }
        
        // V√©rifier que la r√©ponse n'est pas vide
        if (!response || response.trim() === '') {
            response = 'D√©sol√©, je n\'ai pas pu g√©n√©rer une r√©ponse. Veuillez r√©essayer.';
        }

        // Attendre 2 secondes avant d'envoyer la r√©ponse
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Envoyer la r√©ponse
        await sendLongMessage(senderId, response);

    } catch (error) {
        console.error('Erreur lors de l\'appel √† l\'API:', error);

        // Envoyer un message d'erreur √† l'utilisateur
        await sendLongMessage(senderId, "D√©sol√©, une erreur s'est produite lors du traitement de votre message.");
    }
};

// Ajouter les informations de la commande
module.exports.info = {
    name: "tojo",
    description: "Discutez avec le bot Tojo, qui peut analyser vos images et r√©pondre √† vos questions.",
    usage: "Envoyez 'tojo <message>' pour poser une question, joignez une image pour l'analyser, ou 'clear' pour r√©initialiser la conversation."
};
