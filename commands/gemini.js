
const axios = require('axios');
const sendMessage = require('../handles/sendMessage');

// Stockage des images en attente par utilisateur
const pendingImages = {};

module.exports = async (senderId, prompt, api, imageAttachments) => {
    try {
        const API_ENDPOINT = "https://kaiz-apis.gleeze.com/api/gemini-vision";
        const API_KEY = "669397c862ff2e8c9b606584f50ccfa7684efe4eccc435c0bf51a3eba23dc225"; // Votre cl√© API Kaiz
        const UID = Math.floor(Math.random() * 1000000).toString(); // UID al√©atoire

        // V√©rifier si nous avons affaire √† un attachement image
        if (imageAttachments && imageAttachments.length > 0) {
            // Stocker l'URL de l'image pour cet utilisateur
            pendingImages[senderId] = imageAttachments[0].payload.url;
            
            // Envoyer un message confirmant la r√©ception de l'image
            await sendMessage(senderId, "üß† Image re√ßue! Posez votre question √† propos de cette image ou envoyez 'gemini' pour l'analyser.");
            return { skipCommandCheck: true };
        }

        // R√©cup√©rer l'image en attente si elle existe
        let imageUrl = pendingImages[senderId] || null;

        // Si le prompt est vide et qu'il n'y a pas d'image
        if ((!prompt || prompt.trim() === '') && !imageUrl) {
            await sendMessage(senderId, "üß† Gemini AI Bot\n\n‚ùå Veuillez fournir une question ou r√©pondre √† une image.");
            return;
        }

        // Envoyer un message d'attente
        await sendMessage(senderId, "üß† Gemini r√©fl√©chit √† votre demande...");

        // Construire les param√®tres de la requ√™te
        const queryParams = new URLSearchParams({
            q: prompt || "",
            uid: UID,
            imageUrl: imageUrl || "",
            apikey: API_KEY
        });

        const fullUrl = `${API_ENDPOINT}?${queryParams.toString()}`;
        const response = await axios.get(fullUrl);
        const result = response?.data?.response;

        if (!result) {
            await sendMessage(senderId, "‚ö†Ô∏è Aucune r√©ponse re√ßue de l'API Gemini.");
            return;
        }

        // Formater la r√©ponse
        const formattedResponse = `üß† GEMINI AI BOT ü§ñ\n\n${result}\n\n‚ú® Propuls√© par Gemini Vision API`;

        // Envoyer la r√©ponse en g√©rant les messages longs
        const MAX_MESSAGE_LENGTH = 2000;
        if (formattedResponse.length > MAX_MESSAGE_LENGTH) {
            // Diviser le message en chunks
            const chunks = [];
            let startIndex = 0;
            
            while (startIndex < formattedResponse.length) {
                let endIndex = startIndex + MAX_MESSAGE_LENGTH;
                
                if (endIndex < formattedResponse.length) {
                    // Chercher le dernier point ou espace pour une coupure propre
                    const lastPeriod = formattedResponse.lastIndexOf('.', endIndex);
                    const lastSpace = formattedResponse.lastIndexOf(' ', endIndex);
                    const breakPoint = Math.max(lastPeriod, lastSpace);
                    
                    if (breakPoint > startIndex) {
                        endIndex = breakPoint + 1;
                    }
                }
                
                chunks.push(formattedResponse.substring(startIndex, endIndex));
                startIndex = endIndex;
            }
            
            // Envoyer chaque chunk avec une pause
            for (let i = 0; i < chunks.length; i++) {
                await sendMessage(senderId, chunks[i]);
                if (i < chunks.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        } else {
            await sendMessage(senderId, formattedResponse);
        }

        // Supprimer l'image en attente apr√®s utilisation
        if (pendingImages[senderId]) {
            delete pendingImages[senderId];
        }

    } catch (error) {
        console.error("‚ùå Erreur Gemini AI:", error?.response?.data || error.message || error);
        await sendMessage(senderId, "‚ùå Une erreur s'est produite lors du traitement de votre demande. Veuillez r√©essayer plus tard.");
    }
};

// Ajouter les informations de la commande
module.exports.info = {
    name: "gemini",
    description: "Posez des questions √† Gemini AI avec ou sans image en utilisant l'API Kaiz Gemini Vision.",
    usage: "Envoyez 'gemini <question>' ou r√©pondez √† une image avec 'gemini <question>'"
};
